{"cells":[{"kind":1,"language":"markdown","value":"see https://docs.couchbase.com/cloud/n1ql/n1ql-language-reference/groupby.html#letting-clause"},{"kind":2,"language":"SQL++","value":"select raw { person.name: TRUNC(ARRAY_AVG(person.ratings), 2) }\r\nfrom [\r\n    { \"name\": 'John', \"ratings\": [3.5, 5.0, 4.5] },\r\n    { \"name\": 'Mary', \"ratings\": [5.0] },\r\n    { \"name\": 'Adam' },\r\n    { \"name\": 'Jack', \"ratings\": [4.8, 4.4, 4.9] }\r\n] person\r\nwhere person.ratings IS NOT MISSING\r\ngroup by person.name, person.ratings\r\nhaving ARRAY_LENGTH(person.ratings) > 1\r\n    and ARRAY_AVG(person.ratings) > 4.0\r\norder by ARRAY_AVG(person.ratings) DESC"},{"kind":2,"language":"SQL++","value":"select raw { person.name: TRUNC(avg_rating, 2) }\r\nfrom [\r\n    { \"name\": 'John', \"ratings\": [3.5, 5.0, 4.5] },\r\n    { \"name\": 'Mary', \"ratings\": [5.0] },\r\n    { \"name\": 'Adam' },\r\n    { \"name\": 'Jack', \"ratings\": [4.8, 4.4, 4.9] }\r\n] person\r\nwhere person.ratings IS NOT MISSING\r\ngroup by person.name, person.ratings\r\nLETTING avg_rating = ARRAY_AVG(person.ratings)\r\nhaving ARRAY_LENGTH(person.ratings) > 1\r\n    and avg_rating > 4.0\r\norder by avg_rating DESC"},{"kind":2,"language":"SQL++","value":"select raw { person.name: avg_rating }\r\nfrom [\r\n    { \"name\": 'John', \"ratings\": [3.5, 5.0, 4.5] },\r\n    { \"name\": 'Mary', \"ratings\": [5.0] },\r\n    { \"name\": 'Jack', \"ratings\": [4.8, 4.4, 4.9] }\r\n] person\r\ngroup by person.name, person.ratings\r\nLETTING avg_rating = TRUNC(ARRAY_AVG(person.ratings), 2)\r\nhaving avg_rating > 4.0\r\norder by avg_rating DESC"}]}